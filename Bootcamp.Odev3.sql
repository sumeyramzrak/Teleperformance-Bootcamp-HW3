use Teleperformance

--**************************************** TABLOLAR ****************************************

--Kullanýcýlar tablosu 

CREATE TABLE Users
(
    UserID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	UserName NVARCHAR(50) NOT NULL,
	Email VARCHAR(50) NOT NULL,
	Password NVARCHAR(50) NOT NULL,
	IsActive BIT ,
	IsDeleted BIT ,
	CreatedAt DATETIME DEFAULT GETDATE()
)

INSERT INTO Users (UserName,Email,Password,IsActive,IsDeleted) VALUES 
('Monica','m123@gmail.com','123',1,0),
('Ross','r123@gmail.com','123',1,0),
('Rachel','r456@gmail.com','123',1,0),
('Chandler','c123@gmail.com','123',1,0),
('Joey','j123@gmail.com','123',1,0),
('Phoebe','p123@gmail.com','123',1,0),
('Emma','e123@gmail.com','123',1,0),
('Ben','e123@gmail.com','123',1,0);

--gruplar tablosu

CREATE TABLE Groups
(
ID INT IDENTITY(1,1) PRIMARY KEY,
GroupID UNIQUEIDENTIFIER  DEFAULT NEWID(),
GroupName NVARCHAR(50) NOT NULL,
MemberID UNIQUEIDENTIFIER,
CreatedBy UNIQUEIDENTIFIER NOT NULL,
CreatedAt DATETIME DEFAULT GETDATE(), 
ModifiedAt DATETIME DEFAULT GETDATE(),
IsDeleted BIT 

CONSTRAINT FK_MemberId FOREIGN KEY (MemberID) REFERENCES Users(UserID),
CONSTRAINT FK_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES Users(UserID),
)

INSERT INTO Groups (GroupName,CreatedBy,MemberID) VALUES 
('Group1','14419A9A-3B92-464D-818B-73383BDD85C8','2D1D46B9-E2D7-4C6B-9D5A-7A1DC21DFCB9'),
('Group1','14419A9A-3B92-464D-818B-73383BDD85C8','2A9E2204-B353-4421-B533-7ABCC0332298'),
('Group2','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','08748A4E-E6BD-4AE7-A980-BA9046303AA1'),
('Group2','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','3F0BF673-2AE1-4573-851B-CB83C58767DB'),
('Group2','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','DCC2014C-B80C-4CF7-BC63-A88996680CDA');

--Mesaj tipi tablosu (Dosya yoluna göre)

CREATE TABLE MessageType
(
    ID SMALLINT IDENTITY(1,1) PRIMARY KEY,
	MessageType VARCHAR(10) NOT NULL,
	CreatedAt DATETIME DEFAULT GETDATE(),	
	IsDeleted BIT 
)

INSERT INTO MessageType (MessageType) VALUES 
('.txt'),
('.doc'),
('.jpg'),
('.mp4'),
('.gif');

--Gönderim Tipi Tablosu (Public, Kiþi ,Grup)

CREATE TABLE MessageSendType
(
    ID SMALLINT IDENTITY(1,1) PRIMARY KEY,
	MessageType VARCHAR(10) NOT NULL,
	CreatedAt DATETIME DEFAULT GETDATE(),
	IsDeleted BIT 
)


INSERT INTO MessageSendType (MessageType) VALUES 
('Public'),
('User'),
('Users'),
('Group');

--Mesajlar tablosu 

CREATE TABLE Messages 
(
    MessageID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    FromID UNIQUEIDENTIFIER NOT NULL,
    Content NVARCHAR(250),
    MessageType  SMALLINT,
    IsPublic BIT,
    SendType  SMALLINT,
    ToID UNIQUEIDENTIFIER,
	CreatedAt DATETIME DEFAULT GETDATE(),	
	IsDeleted BIT DEFAULT 0,
	
    CONSTRAINT FK_FromId FOREIGN KEY (FromID) REFERENCES Users(UserID),
	CONSTRAINT FK_MessageType FOREIGN KEY (MessageType) REFERENCES MessageType(ID),
	CONSTRAINT FK_SendType FOREIGN KEY (SendType) REFERENCES MessageSendType(ID),
)


INSERT INTO Messages (FromID,MessageType,Content,IsPublic,SendType,ToID) VALUES 
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','',1,0,2,'08748A4E-E6BD-4AE7-A980-BA9046303AA1'),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','',1,0,4,'73137A67-4D80-4233-B27C-A3147875304E'),
('05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','',1,0,3,'32DD7C01-1EB9-47FC-B97B-E20A43B26F86'),
('05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','',1,0,3,'DCC2014C-B80C-4CF7-BC63-A88996680CDA'),
('05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','',1,0,3,'14419A9A-3B92-464D-818B-73383BDD85C8'),
--güncellenen mesaj tablosu

CREATE TABLE MessageHistory
(
ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
MessageID UNIQUEIDENTIFIER NOT NULL,
UpdatedPerson UNIQUEIDENTIFIER NOT NULL,
Content NVARCHAR(250),
CreatedAt DATETIME DEFAULT GETDATE(), 
ModifiedAt DATETIME DEFAULT GETDATE(),
IsDeleted BIT ,

CONSTRAINT FK_UpdatedPerson FOREIGN KEY (UpdatedPerson) REFERENCES Users(UserID),
CONSTRAINT FK_MessageId FOREIGN KEY (MessageID) REFERENCES Messages(MessageID)

)

DROP TABLE MessageHistory

INSERT INTO MessageHistory (MessageID,UpdatedPerson,Content) VALUES 
('4B552467-7150-4FA4-B2EF-28351857B5DB','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4','aa')

--Yorumlar tablosu

CREATE TABLE Comments 
(
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    MessageID UNIQUEIDENTIFIER NOT NULL,
	Content NVARCHAR(30) NOT NULL,
    CreatedBy UNIQUEIDENTIFIER NOT NULL,
	CreatedAt DATETIME DEFAULT GETDATE(),
	ModifiedAt DATETIME DEFAULT GETDATE(),
	IsDeleted BIT ,
	
	CONSTRAINT FK_CommentsCreatedBy FOREIGN KEY (CreatedBy) REFERENCES Users(UserID),
    CONSTRAINT FK_CommentsMessageID FOREIGN KEY (MessageID) REFERENCES Messages(MessageID)
)

INSERT INTO Comments (MessageID,Content,CreatedBy) VALUES 
('4B552467-7150-4FA4-B2EF-28351857B5DB','Comment1','14419A9A-3B92-464D-818B-73383BDD85C8')

--arkadaþlýk tablosu

CREATE TABLE Friendship

(
ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
Person1ID UNIQUEIDENTIFIER NOT NULL,
Person2ID UNIQUEIDENTIFIER NOT NULL,
CreatedAt DATETIME DEFAULT GETDATE(), 
ModifiedAt DATETIME DEFAULT GETDATE(),
IsDeleted BIT,

CONSTRAINT FK_Person1 FOREIGN KEY (Person1ID) REFERENCES Users(UserID),
CONSTRAINT FK_Person2 FOREIGN KEY (Person2ID) REFERENCES Users(UserID)
)

INSERT INTO Friendship (Person1ID,Person2ID) VALUES 
('14419A9A-3B92-464D-818B-73383BDD85C8','2A9E2204-B353-4421-B533-7ABCC0332298'),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','08748A4E-E6BD-4AE7-A980-BA9046303AA1'),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4'),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','32DD7C01-1EB9-47FC-B97B-E20A43B26F86')

--arkadaþlýk isteði tablosu

CREATE TABLE FriendRequest
(

ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
UserID UNIQUEIDENTIFIER NOT NULL,
FollowingID UNIQUEIDENTIFIER NOT NULL,
IsAccepted BIT,
CreatedAt DATETIME DEFAULT GETDATE(), 
ModifiedAt DATETIME DEFAULT GETDATE(),
IsDeleted BIT,

CONSTRAINT FK_UserID FOREIGN KEY (UserID) REFERENCES Users(UserID),
CONSTRAINT FK_FollowingID FOREIGN KEY (FollowingID) REFERENCES Users(UserID)
)

INSERT INTO FriendRequest (UserID,FollowingID,IsAccepted) VALUES 
('14419A9A-3B92-464D-818B-73383BDD85C8','2A9E2204-B353-4421-B533-7ABCC0332298',1),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','08748A4E-E6BD-4AE7-A980-BA9046303AA1',1),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4',1),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','32DD7C01-1EB9-47FC-B97B-E20A43B26F86',1),
('3F0BF673-2AE1-4573-851B-CB83C58767DB','2A9E2204-B353-4421-B533-7ABCC0332298',0),
('2D1D46B9-E2D7-4C6B-9D5A-7A1DC21DFCB9','08748A4E-E6BD-4AE7-A980-BA9046303AA1',0),
('32DD7C01-1EB9-47FC-B97B-E20A43B26F86','05DA19F6-BEBF-4AE7-9521-E1D7C746D3C4',0),
('DCC2014C-B80C-4CF7-BC63-A88996680CDA','32DD7C01-1EB9-47FC-B97B-E20A43B26F86',0)


--**************************************** QUERY ****************************************

--En çok mesaj atan kullanýcý

SELECT TOP 1 u.UserName AS [En Çok Mesaj Atan Kullanýcý] ,COUNT(m.FromID) AS [Mesaj Sayýsý] FROM Messages m 
INNER JOIN Users u ON m.FromID =u.UserID 
GROUP BY u.UserName
ORDER BY [Mesaj Sayýsý] DESC

--**************************************** TRIGGER ****************************************

--User tablosundan veri silinemesin. IsDeleted=1 olsun

CREATE OR ALTER TRIGGER UserIsBeingDeleted
ON Users INSTEAD OF DELETE 
AS BEGIN 
	DECLARE @Id UNIQUEIDENTIFIER
	SELECT @Id = UserID  FROM DELETED
	UPDATE Users  SET IsDeleted = 1 WHERE UserID  = @Id
END

--Trigger Deneme

DELETE FROM Users WHERE UserID  = '14419A9A-3B92-464D-818B-73383BDD85C8'

--**************************************** TRIGGER+STORE PROCEDURE ****************************************

--Mesaj içeriði deðiþtirildiðinde Mesaj içeriðini history tablosunda tutsun.

CREATE OR ALTER TRIGGER UpdateMessage
ON Messages AFTER UPDATE 
AS BEGIN 
	DECLARE @MessageID UNIQUEIDENTIFIER;
	DECLARE @Content NVARCHAR(250);
	DECLARE @UpdatedPerson UNIQUEIDENTIFIER;
	SELECT @MessageID = MessageID FROM DELETED
	INSERT INTO MessageHistory (MessageID,UpdatedPerson,Content) VALUES  (@MessageID, @UpdatedPerson,@Content)
	UPDATE Messages SET Content  = @Content WHERE MessageID  = @MessageID
END

CREATE OR ALTER PROCEDURE sp_UpdateMessage(@MessageID  UNIQUEIDENTIFIER,@NewContent NVARCHAR(250))
AS BEGIN
UPDATE Messages SET Content=@NewContent WHERE MessageID=@MessageID  
END

exec sp_UpdateMessage '8646DB4D-6FAA-4CE7-9DD6-50AE0C5EC599', 'Updated' 













